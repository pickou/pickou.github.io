<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fasttext source code reading - Minerva</title>
    <meta name="author"  content="jcyan">
    <meta name="description" content="fasttext source code reading">
    <meta name="keywords"  content="c++, fasttext, tool">
    <!-- Open Graph -->
    <meta property="og:title" content="fasttext source code reading - Minerva">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://pickou.cn/blog/2018/01/11/fasttext-source-code.html">
    <meta property="og:description" content="Minerva is the goddess of wisdom in ancient Rome. Here for inpiration and idea spreading.">
    <meta property="og:site_name" content="Minerva">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/app.min.css">
</head>
<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
<input id="nm-switch" type="hidden" value="false">

<header class="g-header">
    <div class="g-logo">
      <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
        </ul>
    </nav>
</header>


<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default post-no-cover" data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
            
            
            <a href="http://pickou.cn/tags#c++" class="post-tag">c++</a>
            
            <a href="http://pickou.cn/tags#fasttext" class="post-tag">fasttext</a>
            
            <a href="http://pickou.cn/tags#tool" class="post-tag">tool</a>
            
            
        </div>
        <h1>fasttext source code reading</h1>
        <div class="post-meta">
            <span class="post-meta-item"><i class="iconfont icon-author"></i><a href="http://pickou.cn" target="_blank" rel="author">jcyan</a></></span>
            <time class="post-meta-item" datetime="18-01-11"><i class="iconfont icon-date"></i>11 Jan 2018</time>
        </div>
    </div>
    
</header>

<div class="post-content">
    <!-- mathjax -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        jax: ["input/Tex", "output/HTML-CSS"],
        text2jax: {
            inlineMath: [['$','$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$']],
            processEscape: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        },
        messageStyle: "none",
        "HTML-CSS": {preferredFont: "Tex", availableFonts: ["STIX", "TEX"]}
    });
    </script>   
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>   
   
    <article class="markdown-body">
        <p>fasttext整个实现并不复杂，整个工程简洁，清楚，是个很好的开源项目，适合我这种新手作为源码阅读的起步。</p>
<h3 id="project-architecture">project architecture</h3>
<p>拿到一份代码之后，首先得分析整个工程的结构,能让你看清楚一个project的结构的有两部分，一部分是<code class="highlighter-rouge">main函数</code>，
还有一部分是<code class="highlighter-rouge">头文件.h</code>。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">argv</span> <span class="o">+</span> <span class="n">argc</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">printUsage</span><span class="p">();</span>
                  <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
                    
      <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">command</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"skipgram"</span> <span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"cbow"</span> <span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"supervised"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">train</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"test"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">test</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"quantize"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">quantize</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"print-word-vectors"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printWordVectors</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"print-sentence-vectors"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printSentenceVectors</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"print-ngrams"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printNgrams</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"nn"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">nn</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"analogies"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">analogies</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"predict"</span> <span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"predict-prob"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">predict</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="s">"dump"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dump</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                  
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printUsage</span><span class="p">();</span>
                    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
                      
        <span class="p">}</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<p>从main函数中可以看到整个fasttext有哪些功能。现在我从<code class="highlighter-rouge">train(args)</code>入手，看fasttext训练embedding的整个过程。</p>
<h3 id="train">train</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">train</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Args</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Args</span><span class="p">();</span> <span class="c1">// 参数解析的类</span>
    <span class="n">a</span><span class="p">.</span><span class="n">parseArgs</span><span class="p">(</span><span class="n">args</span><span class="p">);</span> <span class="c1">//解析参数</span>
    <span class="n">FastText</span> <span class="n">fasttext</span><span class="p">;</span> <span class="c1">// fasttext类</span>
    <span class="n">fasttext</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// 训练</span>
    <span class="n">fasttext</span><span class="p">.</span><span class="n">saveModel</span><span class="p">();</span> <span class="c1">// 保存模型</span>
    <span class="n">fasttext</span><span class="p">.</span><span class="n">saveVectors</span><span class="p">();</span> <span class="c1">// 保存训练好的embedding</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">saveOutput</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fasttext</span><span class="p">.</span><span class="n">saveOutput</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>那么，接下来重点就放到一个<code class="highlighter-rouge">Args</code>参数解析类和<code class="highlighter-rouge">fasttext</code>类上。</p>

<h3 id="args">Args</h3>
<p>可以看到，Args类的成员变量就是fasttext
需要的参数。参数的具体意义可以在这里找到<a href="https://github.com/facebookresearch/fastText/blob/master/docs/options.md">link</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Args</span> <span class="p">{</span>
  <span class="k">protected</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">lossToString</span><span class="p">(</span><span class="n">loss_name</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">boolToString</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">modelToString</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="n">Args</span><span class="p">();</span><span class="c1">// 构造函数</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">input</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">output</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">lr</span><span class="p">;</span> <span class="c1">// learning rate</span>
    <span class="kt">int</span> <span class="n">lrUpdateRate</span><span class="p">;</span> <span class="c1">// change the rate of updates for the learning rate</span>
    <span class="kt">int</span> <span class="n">dim</span><span class="p">;</span> <span class="c1">// embedding 维度</span>
    <span class="kt">int</span> <span class="n">ws</span><span class="p">;</span> <span class="c1">// size of context window</span>
    <span class="kt">int</span> <span class="n">epoch</span><span class="p">;</span> <span class="c1">// 迭代次数</span>
    <span class="kt">int</span> <span class="n">minCount</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">minCountLabel</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">neg</span><span class="p">;</span> <span class="c1">// number of negatives sampled</span>
    <span class="kt">int</span> <span class="n">wordNgrams</span><span class="p">;</span>
    <span class="n">loss_name</span> <span class="n">loss</span><span class="p">;</span>
    <span class="n">model_name</span> <span class="n">model</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">bucket</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">minn</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">maxn</span><span class="p">;</span>
    <span class="kt">int</span> <span class="kr">thread</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">label</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">verbose</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">pretrainedVectors</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">saveOutput</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">qout</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">retrain</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">qnorm</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">cutoff</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">dsub</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">parseArgs</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">printHelp</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">printBasicHelp</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">printDictionaryHelp</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">printTrainingHelp</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">printQuantizationHelp</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">save</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">dump</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
<span class="p">};</span>

</code></pre></div></div>
<p>构造函数里面给成员变量赋初值，从这个类里面学会了<code class="highlighter-rouge">enum class</code>的妙用,
enum class 是c++ 11的特性，<a href="https://zhuanlan.zhihu.com/p/21722362">link</a></p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="k">class</span> <span class="nc">loss_name</span><span class="o">:</span> <span class="kt">int</span> <span class="p">{</span><span class="n">hs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">softmax</span><span class="p">};</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Args</span><span class="o">::</span><span class="n">lossToString</span><span class="p">(</span><span class="n">loss_name</span> <span class="n">ln</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ln</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">loss_name</span><span class="p">:</span><span class="o">:</span><span class="n">hs</span><span class="o">:</span>
      <span class="k">return</span> <span class="s">"hs"</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">loss_name</span><span class="p">:</span><span class="o">:</span><span class="n">ns</span><span class="o">:</span>
      <span class="k">return</span> <span class="s">"ns"</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">loss_name</span><span class="p">:</span><span class="o">:</span><span class="n">softmax</span><span class="o">:</span>
      <span class="k">return</span> <span class="s">"softmax"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="s">"Unknown loss!"</span><span class="p">;</span> <span class="c1">// should never happen</span>
<span class="p">}</span><span class="k">class</span> <span class="nc">Model</span> <span class="p">{</span>
  <span class="k">protected</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span> <span class="n">wi_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span> <span class="n">wo_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span> <span class="n">qwi_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span> <span class="n">qwo_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span> <span class="n">args_</span><span class="p">;</span>
    <span class="n">Vector</span> <span class="n">hidden_</span><span class="p">;</span>
    <span class="n">Vector</span> <span class="n">output_</span><span class="p">;</span>
    <span class="n">Vector</span> <span class="n">grad_</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">hsz_</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">osz_</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">loss_</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">nexamples_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">real</span><span class="o">&gt;</span> <span class="n">t_sigmoid_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">real</span><span class="o">&gt;</span> <span class="n">t_log_</span><span class="p">;</span>
    <span class="c1">// used for negative sampling:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span> <span class="n">negatives_</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">negpos</span><span class="p">;</span>
    <span class="c1">// used for hierarchical softmax:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">paths</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">codes</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">tree</span><span class="p">;</span>

    <span class="k">static</span> <span class="kt">bool</span> <span class="n">comparePairs</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">);</span>

    <span class="kt">int32_t</span> <span class="n">getNegative</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">target</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">initSigmoid</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">initLog</span><span class="p">();</span>

    <span class="k">static</span> <span class="k">const</span> <span class="kt">int32_t</span> <span class="n">NEGATIVE_TABLE_SIZE</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="n">Model</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">);</span>

    <span class="n">real</span> <span class="n">binaryLogistic</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span>
    <span class="n">real</span> <span class="n">negativeSampling</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span>
    <span class="n">real</span> <span class="n">hierarchicalSoftmax</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span>
    <span class="n">real</span> <span class="n">softmax</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span>

    <span class="kt">void</span> <span class="n">predict</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">,</span>
                 <span class="n">Vector</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">predict</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">dfs</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span>
             <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">,</span>
             <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">findKBest</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">,</span>
                   <span class="n">Vector</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">computeHidden</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">computeOutputSoftmax</span><span class="p">(</span><span class="n">Vector</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">computeOutputSoftmax</span><span class="p">();</span>

    <span class="kt">void</span> <span class="n">setTargetCounts</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">initTableNegatives</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">buildTree</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&amp;</span><span class="p">);</span>
    <span class="n">real</span> <span class="n">getLoss</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">real</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">log</span><span class="p">(</span><span class="n">real</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">std_log</span><span class="p">(</span><span class="n">real</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">minstd_rand</span> <span class="n">rng</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">quant_</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">setQuantizePointer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">bool</span><span class="p">);</span>
<span class="p">};</span>


</code></pre></div></div>
<p>我更关心的是fasttext类,所以赶紧去看看fasttext.h。</p>
<h3 id="fasttext">fasttext</h3>
<p>这里就不放代码了,还是从<a href="https://github.com/facebookresearch/fastText/blob/master/src/fasttext.h">fasttext.h</a>入手，
我关心这几个方面，一个方面是输入是如何读取的,第二个是如何训练的,用的什么数据结构，第三个是模型存储是怎么做到的，用的什么方式。
在这个头文件中，看到<code class="highlighter-rouge">std::shared_ptr</code>，这是c++11的特性，传统的动态内存分配和释放使用new和delete,但是很容易出现忘记释放内存的情况，
这个时候<strong>智能指针</strong>就解决了这个问题，它自动释放内存,是<strong>模板</strong>，初始化的方法和vector是一样的,存在头文件<strong>memory</strong>中。另外一个
就是使用了很多<code class="highlighter-rouge">const</code>，TODO             。找到<a href="https://github.com/facebookresearch/fastText/blob/master/src/fasttext.cc">fasttext.cc</a>
,找到train函数，其中输入数据读取是由下面这个函数解决的。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dict_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Dictionary</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args_</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">ifs</span><span class="p">(</span><span class="n">args_</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifs</span><span class="p">.</span><span class="n">is_open</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">invalid_argument</span><span class="p">(</span>
        <span class="n">args_</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">+</span> <span class="s">" cannot be opened for training!"</span>
    <span class="p">);</span>
<span class="p">}</span>
  <span class="n">dict_</span><span class="o">-&gt;</span><span class="n">readFromFile</span><span class="p">(</span><span class="n">ifs</span><span class="p">);</span>
  <span class="n">ifs</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><span class="err">`</span>
</code></pre></div></div>
<p>接下去就该去<a href="https://github.com/facebookresearch/fastText/blob/master/src/dictionary.h">dictionary.h</a>中寻找输入读取的细节。首先找到readFromFile这个函数,比较关键的几个函数分别是<code class="highlighter-rouge">readWord(word)</code>,<code class="highlighter-rouge">add(word)</code>,<code class="highlighter-rouge">threshhold</code>, <code class="highlighter-rouge">initTableDiscard</code>和<code class="highlighter-rouge">initNgrams</code>。</p>
<ul>
  <li>先去看readWord，发现这个函数就是读取一个词的，分割符号类似<code class="highlighter-rouge">" ", "\r", "\t"</code>之类的</li>
  <li>add的实现有些技巧，使用了hash的方式将词进行编码，这样在查找词的时候就会更快，hash采用的32位的<a href="http://www.cppblog.com/koson/archive/2010/03/11/109446.html">NFV算法</a>,
词被存在<strong>words_</strong>里面，它是个vector,每个元素是一个entry的结构体，包含了这个词，词的词频，以及是label还是word,还有子单词的信息。</li>
  <li>threshold是为了去掉频率过低和过高的词,这里用到了<strong>lambda</strong>表达式
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">words_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">remove_if</span><span class="p">(</span><span class="n">words_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">words_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">entry</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">entry_type</span><span class="o">::</span><span class="n">word</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">entry_type</span><span class="o">::</span><span class="n">label</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">tl</span><span class="p">);</span>
  <span class="p">}),</span> <span class="n">words_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</code></pre></div>    </div>
    <p>remove_if和erase一般成对出现,lambda表达式查阅<a href="http://zh.cppreference.com/w/cpp/language/lambda">link</a>
同时，vector里面使用了函数<code class="highlighter-rouge">shrink_to_fit</code>,这个函数可以释放掉vector中被erase掉的内存空间。</p>
  </li>
  <li>initTableDiscard，从新计算一个词的词频，并把计算的词频放到pdiscard_中,这里采用了一个技巧,计算词频的时候做了一个
缩放<script type="math/tex">\sqrt{x/f}+x/f</script>，其中f取0.0001,这样能保证f过小的时候整个数不会太大，f过大的时候整个值也不会太小。
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">Dictionary</span><span class="o">::</span><span class="n">initTableDiscard</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pdiscard_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size_</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">real</span> <span class="n">f</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">words_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">)</span> <span class="o">/</span> <span class="n">real</span><span class="p">(</span><span class="n">ntokens_</span><span class="p">);</span>
      <span class="n">pdiscard_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">args_</span><span class="o">-&gt;</span><span class="n">t</span> <span class="o">/</span> <span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">args_</span><span class="o">-&gt;</span><span class="n">t</span> <span class="o">/</span> <span class="n">f</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>initNgrams主要部分在computeSubwords这个函数中，所以找到这个函数分析。
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if ((word[i] &amp; 0xC0) == 0x80) continue;
</code></pre></div>    </div>
    <p>这句话为了检测编码是不是10开头的utf-8，因为10开始的utf-8编码，表示一个多字节序的子序,具体的可以参见reference.
数据处理这部分就算差不多了,接着去看模型训练的过程,</p>
  </li>
</ul>

<p>还是接着看train函数，loadVector这个函数就没什么好看的了，就是从文件中读取训练好的embedding.接下来，看到这段代码的时候，
这就是开始了模型的训练，两个模块比较重要，一个是<strong>startThreads()</strong>,另外一个就是<strong>Model</strong>。</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">startThreads</span><span class="p">();</span>
  <span class="n">model_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">&gt;</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">output_</span><span class="p">,</span> <span class="n">args_</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">args_</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">model_name</span><span class="o">::</span><span class="n">sup</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">model_</span><span class="o">-&gt;</span><span class="n">setTargetCounts</span><span class="p">(</span><span class="n">dict_</span><span class="o">-&gt;</span><span class="n">getCounts</span><span class="p">(</span><span class="n">entry_type</span><span class="o">::</span><span class="n">label</span><span class="p">));</span>
            
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">model_</span><span class="o">-&gt;</span><span class="n">setTargetCounts</span><span class="p">(</span><span class="n">dict_</span><span class="o">-&gt;</span><span class="n">getCounts</span><span class="p">(</span><span class="n">entry_type</span><span class="o">::</span><span class="n">word</span><span class="p">));</span>

  <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>startThreads  把线程放到vector中，用lambda表达式的值传递方式建立线程,之后采用join方式阻塞线程。</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args_</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span> <span class="n">trainThread</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>  <span class="p">}));</span>
<span class="p">}</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args_</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Model 先将Model分析清楚再去分析trainThread函数，找到<a href="https://github.com/facebookresearch/fastText/blob/master/src/model.h">Model.h</a>,
这个类就是整个fasttext的核心算法所在了。Model里面包含了很多东西，有关quantize的先放到后面分析，看README知道这是后面增加的feature,这个方式
下内存占用会变小,这其实就是对网络做了一个压缩。</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Model</span> <span class="p">{</span>
  <span class="k">protected</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span> <span class="n">wi_</span><span class="p">;</span> <span class="c1">//连接input的权值,其中Matrix类以vector存储了二维的数组，并定义了很多类方法，比如l2NormRow, dotRow等等</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span> <span class="n">wo_</span><span class="p">;</span> <span class="c1">//连接output的权值</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span> <span class="n">qwi_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span> <span class="n">qwo_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span> <span class="n">args_</span><span class="p">;</span>
    <span class="n">Vector</span> <span class="n">hidden_</span><span class="p">;</span> <span class="c1">// 隐藏层单元，Vector类以vector存储隐层单元的值，也定义了很多基于vector的方法</span>
    <span class="n">Vector</span> <span class="n">output_</span><span class="p">;</span> <span class="c1">// 输出层，类型也是Vector</span>
    <span class="n">Vector</span> <span class="n">grad_</span><span class="p">;</span> <span class="c1">// 梯度值</span>
    <span class="kt">int32_t</span> <span class="n">hsz_</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">osz_</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">loss_</span><span class="p">;</span> <span class="c1">// loss值，real即为float</span>
    <span class="kt">int64_t</span> <span class="n">nexamples_</span><span class="p">;</span> <span class="c1">// 样本总数</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">real</span><span class="o">&gt;</span> <span class="n">t_sigmoid_</span><span class="p">;</span> <span class="c1">// 经过sigmoid之后的值</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">real</span><span class="o">&gt;</span> <span class="n">t_log_</span><span class="p">;</span> <span class="c1">//经过</span>
    <span class="c1">// used for negative sampling:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span> <span class="n">negatives_</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">negpos</span><span class="p">;</span>
    <span class="c1">// used for hierarchical softmax:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">paths</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">codes</span><span class="p">;</span> <span class="c1">//存储哈夫曼编码</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">tree</span><span class="p">;</span> <span class="c1">//存储这个编码树</span>

    <span class="k">static</span> <span class="kt">bool</span> <span class="n">comparePairs</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">);</span>

    <span class="kt">int32_t</span> <span class="n">getNegative</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">target</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">initSigmoid</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">initLog</span><span class="p">();</span>

    <span class="k">static</span> <span class="k">const</span> <span class="kt">int32_t</span> <span class="n">NEGATIVE_TABLE_SIZE</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="n">Model</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">);</span>

    <span class="n">real</span> <span class="n">binaryLogistic</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span> <span class="c1">// logistic回归</span>
    <span class="n">real</span> <span class="n">negativeSampling</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span> <span class="c1">// negative sampling 方法</span>
    <span class="n">real</span> <span class="n">hierarchicalSoftmax</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span> <span class="c1">// hs方法</span>
    <span class="n">real</span> <span class="n">softmax</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span> <span class="c1">// softmax方法</span>

    <span class="kt">void</span> <span class="n">predict</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">,</span>
                 <span class="n">Vector</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span> <span class="c1">// predict方法</span>
    <span class="kt">void</span> <span class="n">predict</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">dfs</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span>
             <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">,</span>
             <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span> <span class="c1">// 深度优先遍历方法</span>
    <span class="kt">void</span> <span class="n">findKBest</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">real</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;&gt;&amp;</span><span class="p">,</span>
                   <span class="n">Vector</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span> <span class="c1">// 选出k个最近的</span>
    <span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="n">real</span><span class="p">);</span> <span class="c1">//计算梯度，更新权值</span>
    <span class="kt">void</span> <span class="n">computeHidden</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span> <span class="c1">//计算hidden的值</span>
    <span class="kt">void</span> <span class="n">computeOutputSoftmax</span><span class="p">(</span><span class="n">Vector</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span><span class="c1">//计算经过softmax后的值</span>
    <span class="kt">void</span> <span class="n">computeOutputSoftmax</span><span class="p">();</span>

    <span class="kt">void</span> <span class="n">setTargetCounts</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">initTableNegatives</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&amp;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">buildTree</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;&amp;</span><span class="p">);</span><span class="c1">// 建立哈夫曼树</span>
    <span class="n">real</span> <span class="n">getLoss</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">real</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">log</span><span class="p">(</span><span class="n">real</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">real</span> <span class="n">std_log</span><span class="p">(</span><span class="n">real</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">minstd_rand</span> <span class="n">rng</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">quant_</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">setQuantizePointer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">QMatrix</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">bool</span><span class="p">);</span>
<span class="p">};</span>

</code></pre></div></div>

<ul>
  <li>trainThread 分析完Model的结构,转回trainThread，这个threadId主要是为了给各个线程分配不同的数据。
然后有三个模型,分别是<strong>supervised</strong>，<strong>skipgram</strong>和<strong>cbow</strong>,这里选择一个模型<strong>supervised</strong>继续下面的分析。</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">FastText</span><span class="o">::</span><span class="n">supervised</span><span class="p">(</span>
    <span class="n">Model</span><span class="o">&amp;</span> <span class="n">model</span><span class="p">,</span>
    <span class="n">real</span> <span class="n">lr</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span> <span class="n">line</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;&amp;</span> <span class="n">labels</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">labels</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">line</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">uniform_int_distribution</span><span class="o">&lt;&gt;</span> <span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">labels</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// 均匀分布</span>
    <span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">rng</span><span class="p">);</span>
    <span class="n">model</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="reference">Reference</h3>
<ul>
  <li>https://github.com/facebookresearch/fastText/tree/master/src</li>
  <li>https://stackoverflow.com/questions/3911536/utf-8-unicode-whats-with-0xc0-and-0x80</li>
  <li>http://blog.sina.com.cn/s/blog_7c4f3b160101dv4p.html</li>
</ul>

    </article>
    
    <div class="social-share-wrapper">
        <div class="social-share"></div>
    </div>
    
</div>

<section class="author-detail">
    <section class="post-footer-item author-card">
        <div class="avatar">
            <img src="http://pickou.cn/assets/img/profile.png" alt="">
        </div>
        <div class="author-name" rel="author">jcyan</div>
        <div class="bio">
            <p>Lived it, love it!</p>
        </div>
        
        <ul class="sns-links">
            
            <li>
                <a href="//github.com/pickou" target="_blank">
                    <i class="iconfont icon-github"></i>
                </a>
            </li>
            
            <li>
                <a href="//www.zhihu.com/people/jackyan-55/activities" target="_blank">
                    <i class="iconfont icon-zhihu"></i>
                </a>
            </li>
            
            <li>
                <a href="//www.linkedin.com/in/%E4%BF%8A%E8%B6%85-%E9%A2%9C-524914144/" target="_blank">
                    <i class="iconfont icon-linkedin"></i>
                </a>
            </li>
            
        </ul>
        
    </section>
    <section class="post-footer-item read-next">
        
        
        <div class="read-next-item">
            <a href="/blog/2018/01/08/DianNao-Accelerator.html" class="read-next-link"></a>
            <section>
                <span>DianNao Accelerator</span>
                <p>文章主要关注点在feed forward,而不是back propagation。从deep network中选取...</p>
            </section>
            
        </div>
        
    </section>
    
</section>

<footer class="g-footer">
    <section>Minerva © 2018</section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> </section>
</footer>


<script src="/assets/js/social-share.min.js"></script>
<script>
    socialShare('.social-share', {
        sites: ['wechat','weibo','douban','twitter'],
        wechatQrcodeTitle: "分享到微信朋友圈",
        wechatQrcodeHelper: '<p>扫码后点击右上角</p><p>将本文分享至朋友圈</p>'
    });
</script>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
/*写入自己的disqus信息*/
s.src = 'https://liaokeyu.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
<script src="/assets/js/prism.js"></script>
<script src="/assets/js/index.min.js"></script>

<!--script src="http://pickou.cn/assets/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntil=configured" type="text/javascript"></script> -->

</body>
</html>
